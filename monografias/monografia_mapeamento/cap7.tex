%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  Mapeamento
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\chapter{Mapeamento}
\label{cap:mapeamento}
\paragraph O mapeamento é uma funcionalidade que é tratada de muitas formas dentro da literatura. O uso de algoritmos de mapeamento permite que um agente móvel possa identificar sua posição em um ambiente desconhecido e identificar o local em que está inserido. Com o ambiente devidamente mapeado é possível otimizar a rota uma vez que o agente já o conhece.

Algumas técnicas de mapeamento que foram estudadas:
\begin{itemize}
\item Técnica utilizando o algoritmo \textit{Djkistra} e Subida de Montanha.
\item Método incremental convencional. 
\item Técnica baseada em grafos de visibilidade.
\item SLAM (Simultaneous Localization and Mapping).
\end{itemize}


O método de mapeamento que será incluído no Toolkit Hórus será o SLAM (Simultaneous Localization and Mapping), tendo em vista que ele soluciona dois problemas clássicos da teoria das posições, que define a dificuldade de se localizar em um ambiente desconhecido e a dificuldade de mapear um ambiente onde não se sabe onde está.

\section{SLAM}

O \textit{Simultaneous Localization and Mapping} é uma técnica utilizada em agentes autônomos para o mapeamento de ambientes desconhecidos levando em consideração a sua posição atual como a posição inicial para início do mapeamento. Os sensores que podem ser utilizados para a implementação do são diversos. Para a prova de conceito foi utilizado o odômetro, dispositivo que mensura distâncias percorridas, e o laser, dispositivo para detectar a presença de objetos na cena.

O SLAM é composto por vários segmentos que são independentes e tem suas comunicações muito bem estabelecidas o que os torna mais flexíveis quanto aos algoritmos utilizados em cada um dos segmentos. Cada um dos segmentos tem uma enorme gama de algoritmos que o compõe. Foram incorporadas ao \textit{Toolkit} apenas as mais otimizadas e relevantes para melhor utilização no processo.

Esses segmentos são:
\begin{enumerate} 
	\item \textit{Landmark Extraction}: Segmento responsável pela extração de marcos no ambiente.
	\item \textit{Data Association}: Segmento que associa os dados extraídos de um mesmo marco por diferentes leituras do laser.
	\item \textit{State Estimation}: Segmento responsável por estimar a posição atual do robô com base em seu odômetro e nas extrações de marcos no ambiente.
	\item \textit{State Update}: Segmento que atualiza o estado atual do agente.
	\item \textit{Landmark Update}: Segmento que atualiza as posições dos marcos no ambiente em relação ao agente.
\end{enumerate} 

\subsection{Landmark Straction}
A forma de gestão dos marcos (objetos) e dos pontos de movimentação (áreas de movimentação do agente) foi feita através de um grafo. A escolha dessa estrutura foi baseada na sua credibilidade e largo uso na literatura.

Existem dois algoritmos que foram analisados para ser incorporados nesse segmento: o \textit{RANSAC} e o \textit{SPIKE}.

\subsubsection{RANSAC}

O RANSAC (\textit{Random Sampling Consensus}) algoritmo que utiliza-se de uma grande quantidade de informações para estimar os dados relevantes de um modelo matemático. Em conjunto com o SLAM o RANSAC identifica linhas de acordo com os pontos passados pelo laser, através da identificação de pontos muito próximos uns dos outros pode-se concluir que ali existe linhas, ou nesse caso, paredes que impossibilitam a transposição do agente.

\begin{table}[htb]
\centering         
	\begin{algorithmic}                
		\WHILE{
		\begin{itemize}
			\item Houverem leituras de laser não associadas.  
			\item  \textbf{E} o número de leituras for maior que o limiar; 
			\item  \textbf{E} o número de iterações não for maior que o limite.
		\end{itemize}}
		\STATE - Selecionar uma leitura de laser na lista.
		\STATE - Seleciona uma quantidade S de exemplos de leitura do laser que estão associadas a uma quantidade D de graus daquele laser.
		\STATE - Usando esses exemplos S e a leitura original para calcular o menor quadrado que se ajuste a linha. 
		\STATE - Determinar quantas leituras do laser estão dentro de X unidades de medida que melhor se ajustam a linha.
		\IF {O número de leituras do laser que ficam sobre a linha é maior que o Consensus}
		 \STATE - Calcular o novo mínimo quadrado que melhor se ajuste a linha, com base em todas as leituras e a linha formada anteriormente. 
		\STATE - Adicionar o melhor ajuste baseado no calculo anterior. 
		\STATE - Remover o número de leituras que cruzam a linha do total de leituras não associadas. 
		\ENDIF
		\ENDWHILE
	\end{algorithmic}
\caption{Algoritmo RANSAC}
\end{table}

Através de vários marcos o \textit{RANSAC} obtêm uma amostra que será analisada a fim de encontrar pontos próximos, consequentemente uma parede, baseado em um limir de proximidade. Esse limiar é chamado de \textit{Consensus}.


\subsubsection{SPIKE}

O algoritmo de extração de marcos \textit{SPIKE} faz a extração através da análise de um determinado montante de valores do laser, estimada uma diferença muito grande de um marco para outro, por exemplo, 0.6 metros, defini-se um \textit{SPIKE} no marco que diferiu dos demais, isso serve para identificar grandes mudanças no ambiente, como por exeplo um laser lançado através das pernas de uma mesa que geraria grandes diferenças entre os feixes de laser que tocarem a(s) perna(s) e os laser que passarem por entre ela(s). Nesse momento o marco que foi detectado na perna da cadeira se torna um \textit{SPIKE}.

O algoritmo leva em consideração um ambiente onde exitem muitas diferenças entre dois marcos, em ambientes onde não existem tantas diferenças, esse algoritmo não tem eficiência.


\subsection{Data Association}
O segmento \textit{Data Association} (tradução livre: Associação de Dados) é responsável pela filtragem e associação dos dados obtidos através dos dispositivos do agente. 

Uma vez que um marco seja visualizado em um passo do agente e esse mesmo marco é visto novamente em um novo passo, a sua posição mudou, em relação ao agente. O Data Association faz a analíse da posição autal do marco com a sua posição imediatamente aterior, com esse paralelo certifica-se que o marco existe ou se ele foi removido da cena.

Este segmento tem como saída para o State Estimation um lista indexada pela posição do agente contendo os marcos da cena. Dessa forma torna-se mais fácil a localização do marco e em que posição ele foi identificado.

\subsection{State Estimation}
O segmento \textit{State Estimation} (tradução livre: Estimação do Estado) tem com objetivo analisar as informações passadas pelo Data Association e estimar as posições dos marcos e do agente, com essas informações ele prepara as posições de cada elemento na cena e analisa o estado anterior já gravado. 

As posições dos marcos devem coicidir com as mesmas posições deles em posições anteriores do agente (caso os marcos sejam reobservados), essa garantia de que a posição irá coincidir é tida pelo cálculo da posição do marco num plano cartesiano. o cálculo é: 
$$
Landmark(x,y) = (AgentActualPositionX + \cos\theta, AgentActualPositionY + \sin\theta)
$$
a posição do marco leva em consideração posição do robô para identificar em que posição o marco está a partir dele, isso torna o agente capaz de mapear baseado na posição dele e o ângulo é em relação ao laser do agente que colide com marco.

\subsection{State Update}

O \textit{State Update} (tradução livre: Atualização do Estado) faz a gravação do estado atual do agente, sua posição, em relação a posição inicial, valores relativos ao odômetro. Esse passo do SLAM apesar de ter uma resposabilidade aparentemente pequena, leva-se muito tempo para definir o tipo de estrutura que será usada para gravação dos estados. Algumas, com o foco em performance, armazenam em listas devido alta velocidade de gravação, outros preferem uma lista indexada (também conhecido como \textit{map}) para facilitar na busca pelas informações. A mais recomendada é uma lista indexada, utilizando a posição atual como chave.

\subsection{Landmark Update}

Com o mesmo objetivo e com focos diferentes, o Landmark Update (tradução livre: Atualização de marcos) faz a gravação do estado atual dos marcos, sua posição, em relação a posição do agente. Assim como é no \textit{State Update}, no \textit{Landmark Update} é difícil definir a melhor estrutura de dados para armazenamento. A estrutura mais indicada nesse caso também é a lista indexada, que também deve ser indexada pela posição atual do agente.
